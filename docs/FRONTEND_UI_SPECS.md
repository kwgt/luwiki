# フロントエンドUI仕様

## 共通デザイン
  - カードの四隅のラウンドは最小化する
  - カードのシャドウは最小化させる

## フロントエンド設定
  - `config.toml` の `[frontend]` セクションでフォント関連を指定できる
  - 指定値は CSS の `font-family` としてそのまま使用する
  - 設定項目
      - `ui_font` : 画面全体のフォントファミリー
      - `md_font_sans` : Markdown設定のSans選択肢
      - `md_font_serif` : Markdown設定のSerif選択肢
      - `md_font_mono` : Markdown設定のMono選択肢
      - `md_code_font` : Markdownのコードブロック用フォントファミリー
        - 未指定の場合は `md_font_mono` を使用する
  - デフォルト値
      - `ui_font` = `sans-serif`
      - `md_font_sans` = `sans-serif`
      - `md_font_serif` = `serif`
      - `md_font_mono` = `monospace`
      - `md_code_font` = `monospace`

## 画面遷移

  1. 閲覧画面 (開始画面)  
      - 編集ボタンクリック ➡  2. 編集画面へ
      - 履歴ボタンクリック ➡  4. リビジョン管理画面へ
      - 検索ボタンクリック ➡  3. 検索画面へ
  2. 編集画面  
      - 保存ボタンクリック ➡  1. 閲覧画面へ
      - キャンセルボタンクリック ➡  1. 閲覧画面へ
      - ブラウザバック ➡  1. 閲覧画面へ
  3. 検索画面
      - 検索結果クリック ➡  1. 閲覧画面へ
      - ブラウザバック ➡  1. 閲覧画面へ
  4. リビジョン管理画面
      - ブラウザバック ➡  1. 閲覧画面へ

## 表示画面(通常画面)

### レイアウト
以下の様にレイアウトを設定する。

![通常画面レイアウト](./fig/view-page_overview.svg)

### コンポーネント

#### (1) ページタイトル領域
  - ページタイトルとして、本文のトップレベルセクション名を表示する。トップレベルセクションが設定されていない場合はパスの末尾エレメントを表示する。
  - 表示スタイルはH1またH2とし、通常テキストより大きく表示する
  - 領域に入りきらない場合はellipsisではみ出た部分を切り捨てる

#### (2) ページパス領域
  - ページパスに対するパンくずリストを作成し表示する
  - パンくずの各階層にそれぞれのリンクを設定する
  - 表示スタイルはリンクスタイルを維持する
  - 領域に入りきらない場合はellipsisではみ出た部分を切り捨てる

#### (3) 操作ボタン領域
  - リンクスタイルのボタンを列挙配置する
  - 配置するボタンは以下の通り
      - 編集 : 当該ページの編集画面への遷移
      - アセット追加 : アセットのアップロード
      - 移動 : ページパスの変更(リネーム)
      - 削除 : ページの削除
      - 情報表示 : ページのメタ情報のモーダル表示
      - 履歴 : 当該ページのリビジョン管理画面への遷移
      - 検索 : 全文検索の実施(検索画面への遷移)
      - 新規作成 : 新規ページの作成
      - 設定 : 表示設定の変更など

ボタンの配置は以下の様にする。

![操作ボタンレイアウト(表示)](./fig/view-page_buttons.svg)


##### 設定モーダル
「設定」ボタンをクリックしたときに表示されるモーダルでは以下の設定を行わせる。

  - 表示設定
      - 画面テーマ選択(light / dark)
      - Markdownフォント選択 (Sans / Serif / Mono)
      - Markdownフォントサイズ
      - コードブロック文字サイズ
  - 編集設定
      - エディタのキーバインド (Default / Vim / Emacs / VSCode)
      - 行番号の表示 (ON/OFF)

##### 移動操作モーダル
「移動」ボタンをクリックしたときに表示されるモーダルでは以下のコンポーネントを配置する。

  - 移動先パス入力テキストボックス
      - 親ページのパスにパスセパレータを付与した文字列をモーダル表示時のデフォルト値とする。
  - 移動先パスプレビュー領域
      - 移動先パスとして入力されたパスを正規化し、プレビューを行う領域を設ける
  - 再帰的移動指定チェックボックス
  - エラーメッセージ表示テキストブロック
      - 通常は領域の確保だけを行い、エラーがあった場合には赤字でエラーメッセージを記述する。
  - 「キャンセル」ボタン
      - クリックされた場合、何も行わずモーダルを閉じる。  
        モーダルを閉じた後は閲覧画面をそのまま表示する。
  - 「移動」ボタン
      - クリックされた場合、ページパスの変更を行いモーダルを閉じる  
        モーダルを閉じた後は新しいページパスの閲覧画面に遷移させる。

##### ページ新規作成モーダル
「新規作成」ボタンをクリックしたときに表示されるモーダルでは以下のコンポーネントを配置する。
  - パス入力テキストボックス
      - 自ページのパスにパスセパレータを付与した文字列("./"でも可)をモーダル表示時のデフォルト値とする。
  - 新規作成ページパスプレビュー領域
      - 新規作成ページのパスとして入力されたパスを正規化しプレビューを行う領域を設ける
  - エラーメッセージ表示テキストブロック
      - 通常は領域の確保だけを行い、エラーがあった場合には赤字でエラーメッセージを記述する。
  - 「キャンセル」ボタン
      - クリックされた場合、何も行わずモーダルを閉じる  
        モーダルを閉じた後は閲覧画面をそのまま表示する。
  - 「作成」ボタン
      - クリックされた場合モーダルを閉じる  
        モーダルを閉じた後は新規ページのパスの編集画面へ遷移する  
        ドラフトページの作成は編集画面側で行う

#### (4) TOC
  - ページのトップレベルセクションを除くレベル2~4までのセクションに対するTOCを表示する
  - TOCのエントリは各章へのリンクを設定する

#### (5) 本文レンダリング領域
  - ページに設定されたMarkdownをレンダリングしたHTMLを表示させる

#### (6) アセット一覧
  - ページに付随するアセットの一覧を表示する
  - 表示内容はファイル毎に以下の情報をパックしてこれを一単位として表示する
      - ファイル名 : 最大16emまで。それ以上はellipsisで切り捨て
      - サイズ : 補助単位を用い幅を限定させる。例: "1,001KiB"など
      - 詳細表示ボタン : アイコン化リンク
      - ダウンロードボタン : アイコン化リンク
      - ファイル名コピーボタン : アイコン化リンク
      - 削除ボタン : アイコン化リンク
  - 列整列は行わず、アルファベット順に横方向に列挙させる。領域端に達したらラップし次の行へラップさせる。

### コンポーネントの配置
以下の図のように配置する。図中の番号とコンポーネントは以下の様に対応する。

  - (1) ページタイトル領域
  - (2) ページパス領域
  - (3) 操作ボタン領域
  - (4) TOC
  - (5) 本文レンダリング領域
  - (6) アセット一覧
  - (7) サイドパネル表示切り替えボタン


```text
   +-------------------------+
   |           (1)           |
   +-------------------------+
   |           (2)           |
   +-------------------------+
   |           (3)           |
   +-------------------------+
     (7)
   +-----+-------------------+
   |     |                   |
   |     |                   |
   |     |                   |
   |     |                   |
   | (4) |        (5)        |
   |     |                   |
   |     |                   |
   |     |                   |
   |     |                   |
   +-----+-------------------+
         |        (6)        |
         +-------------------+

```

コンポーネント階層は以下の様に定義する。

  - ページビュー画面
      - ヘッダ領域
          - (1) ページタイトル領域
          - (2) ページパス領域
          - (3) 操作ボタン領域
      - ボディ領域
          - サイドパネル
              - (4) TOC
          - コンテンツパネル
              - (5) 本文レンダリング領域
      - フッター領域
          - (6) アセット一覧

なお、ボディ領域の高さは min-heightを画面サイズがlg以上の場合は 100vh - 12.8em、それ以外の画面サイズの場合は 100vh - 11.2em とする。

### 共通状態
  - 対象: 操作可能な要素を含むコンポーネント（例: 操作ボタン領域、アセット一覧の各アイコン）
  - 読み込み中:
      - 対象コンポーネント全体をグレーアウト表示する
      - クリック/タップ操作はすべて無効化する
      - キーボード操作（フォーカス移動/実行）も無効化する
  - エラー発生時:
      - 対象コンポーネント全体をグレーアウト表示する
      - クリック/タップ操作はすべて無効化する
      - エラー内容はモーダルのポップアップ表示を行う

### その他
  - アセットの追加は以下の二通りの方法とする
      - アセット追加ボタンのクリック
      - 編集画面へのファイルのドラッグ＆ドロップ
  - アセットアップロード時にトーストを表示させ、そのトースト上でファイル名のクリップボードへのコピーを行うインタフェースを設ける。
  - アセットアップロードの挙動は表示画面と同一仕様とする。

## 編集画面

### レイアウト
画面サイズ毎に以下の様にレイアウトを設定する。

#### 画面サイズlg以上
![編集画面レイアウト(lg以上)](./fig/edit-page_layout-above-lg.svg)

#### 画面サイズmd以上
![編集画面レイアウト(md以上)](./fig/edit-page_layout-above-md.svg)

#### 画面サイズmd未満
![編集画面レイアウト(md未満)](./fig/edit-page_layout-under-md.svg)

### コンポーネント

#### (1) ページタイトル領域
  - ページタイトルとして、入力中の本文のトップレベルセクション名を表示する。トップレベルセクションが入力されていない場合はパスの末尾エレメントを表示する。
  - 表示スタイルはH1またH2とし、通常テキストより大きく表示する
  - 領域に入りきらない場合はellipsisではみ出た部分を切り捨てる

#### (2) ページパス領域
  - ページパスに対するパンくずリストを作成し表示する
  - 表示画面と異なりリンクは設定しない
  - 領域に入りきらない場合はellipsisではみ出た部分を切り捨てる

#### (3) 操作ボタン領域
  - リンクスタイルのボタンを列挙配置する
  - 配置するボタンは以下の通り
      - アセット追加 : アセットのアップロード
      - テンプレート : テンプレートの適用
          - テンプレート機能が有効化されている場合のみ表示される
          - 本文編集領域に何も入力されいない状態でのみクリック可能になる
          - このボタンがクリックされるとテンプレート選択モーダルを表示し、選択されたテンプレートページの内容を本文編集領域に設定する
      - 保存 : 編集中のページの保存,このページの表示画面への遷移
      - キャンセル : 編集の終了,直前ページへの表示画面への遷移
  - 既存ページの編集時のみ、保存ボタン横に「(リビジョンを維持)」チェックボックスを表示する
      - チェックが有効な場合は保存時にリビジョン維持（amend）を指定する
      - ユーザが操作するまではチェック有りを初期状態とする
      - 文字差分が20文字超または行数差分が2行超の場合は自動でチェックを外す
      - ユーザがチェックを操作した場合は以後の自動変更は行わない
      - 編集ユーザが最終リビジョンの編集ユーザと異なる場合は、チェックを外した状態で無効化する
  - 未編集状態では保存ボタンを無効化し、文字色を `text-neutral-content` 相当にする

ボタンの配置は以下の様にする。

![操作ボタンレイアウト(編集)](./fig/edit-page_buttons.svg)

#### (4) TOC
  - 入力中のMarkdownから抽出された、レベル2~4までのセクションに対するTOCを表示する
  - TOCのエントリは各章へのリンクを設定する

#### (5) 本文編集領域
  - Markdown編集を行う領域
  - エディタを展開する

#### (6) アセット一覧
  - ページに付随するアセットの一覧を表示する
  - 表示画面と同じアイテムを列挙させる

#### (7) プレビュー領域
  - 入力中のMarkdownのリアルタイムレンダリングによるプレビュー表示を行う

#### (8) サイドパネル表示切り替えボタン
  - サイドパネルの表示・非表示を切り替えるボタンを、リンク形式のボタンで配置する
  - 画面サイズがmd以上の場合のみ表示

#### (9) プレビュー切り替えボタン
  - コンテンツパネルの表示を(5) + (6)にするか(7)にするかを切り替えるボタン
  - 画面サイズがlg未満の場合のみ表示

### コンポーネントの配置
画面サイズ毎に以下の図のように配置する。図中の番号とコンポーネントは以下の様に対応する。

  - (1) ページタイトル領域
  - (2) ページパス領域
  - (3) 操作ボタン領域
  - (4) TOC
  - (5) 本文編集領域
  - (6) アセット一覧
  - (7) プレビュー領域
  - (8) サイドパネル表示切り替えボタン
  - (9) プレビュー切り替えボタン

またコンポーネント階層は以下の様に定義する。

  - ページ編集画面
      - ヘッダ領域
          - (1) ページタイトル領域
          - (2) ページパス領域
          - (3) 操作ボタン領域
      - ボディ領域
          - 表示切替ボタン
              - (8) サイドパネル表示切り替えボタン
              - (9) プレビュー切り替えボタン 
          - サイドパネル
              - (4) TOC
          - コンテンツパネル
              - (5) 本文編集領域
              - (7) プレビュー領域
      - フッター領域
          - (6) アセット一覧

なお、サイドパネルとコンテンツパネルの高さは一致させるようにすること。

#### 画面サイズlg以上
```text

   +-------------------------+
   |           (1)           |
   +-------------------------+
   |           (2)           |
   +-------------------------+
   |           (3)           |
   +-------------------------+
    (8)
   +-----+-------------------+--------------------
   |     |                   |                   |
   |     |                   |                   |
   |     |                   |                   |
   |     |                   |                   |
   | (4) |        (5)        |        (7)        |
   |     |                   |                   |
   |     |                   |                   |
   |     |                   |                   |
   |     |                   |                   |
   +-----+-------------------+-------------------+
         |        (6)        |
         +-------------------+
```

なお、このサイズではボディ領域の高さは 100vh - 12.8emで固定させ、各々の領域でコンテンツを独立してスクロールできるようにする。また、TOCエントリのクリックにより(5),(7)は表示位置を移動させ当該箇所が画面に表示されるように位置調整するものとする。

#### 画面サイズmd以上
```text
   +-------------------------+
   |           (1)           |
   +-------------------------+
   |           (2)           |
   +-------------------------+
   |           (3)           |
   +-------------------------+
    (8)    (9)
   +-----+-------------------+
   |     |                   |
   |     |                   |
   |     |                   |
   |     |                   |
   | (4) |    (5) or (7)     |
   |     |  ※(9)で切り替え  |
   |     |                   |
   |     |                   |
   |     |                   |
   +-----+-------------------+
         |        (6)        |
         +-------------------+
```

なお、このサイズではボディ領域の高さは 100vh - 12.8emで固定させ、各々の領域でコンテンツを独立してスクロールできるようにする。また、TOCエントリのクリックにより(5),(7)は表示位置を移動させ当該箇所が画面に表示されるように位置調整するものとする。

#### 画面サイズmd未満
```text
   +-------------------+
   |        (1)        |
   +-------------------+
   |        (2)        |
   +-------------------+
   |        (3)        |
   +-------------------+
     (9)
   +-------------------+
   |                   |
   |                   |
   |                   |
   |                   |
   |    (5) or (7)     |
   |  ※(9)で切り替え  |
   |                   |
   |                   |
   |                   |
   +-------------------+
   |        (6)        |
   +-------------------+
```

なお、このサイズでは(5) or (7)の高さは min-heightを100vh - 12.8emとするが固定はしない。

### 共通状態
  - 対象: 操作可能な要素を含むコンポーネント（例: 操作ボタン領域、アセット一覧の各アイコン）
  - 読み込み中:
      - 対象コンポーネント全体をグレーアウト表示する
      - クリック/タップ操作はすべて無効化する
      - キーボード操作（フォーカス移動/実行）も無効化する
  - エラー発生時:
      - 対象コンポーネント全体をグレーアウト表示する
      - クリック/タップ操作はすべて無効化する
      - エラー内容はモーダルのポップアップ表示を行う

### その他
  - 編集対象パスに削除済みページ候補が存在する場合は、復活の選択肢を提示する
      - `GET /api/pages/deleted?path=...` で候補を取得する
      - 候補選択時は `GET /api/pages/{page_id}/source` で内容を表示する
      - 復活確定時は `POST /api/pages/{page_id}/path?restore_to=...` を呼び出す
  - アセットの追加は以下の二通りの方法とする
      - アセット追加ボタンのクリック
      - 表示画面へのファイルのドラッグ＆ドロップ
  - アセットアップロード時にトーストを表示させ、そのトースト上でファイル名のクリップボードへのコピーを行うインタフェースを設ける。

## 検索画面

### レイアウト
![検索画面レイアウト](./fig/search-page_overview.svg)

### コンポーネント

#### (1) ヘッダ領域
  - 表示スタイルはH1またH2とし、固定文字列で「全文検索」と表示する

#### (2) 検索式入力領域
  - 検索式入力用のテキストボックスが配置される
  - 入力内容の変更に応じて検索をリアルタイムに行う

#### (3) 検索式入力領域
  - 検索式入力用のテキストボックスが配置される
  - 入力内容の変更に応じて検索をリアルタイムに行う

#### (4) 検索設定領域
  - 検索設定として以下のチェックボックスを置く
    - 検索対象の選択 (必ずどれかを選択する必要あり、かつ複数指定可)
      1. 見出しを検索する
      2. 本文を検索する
      3. コードブロックを検索する
    - オプション
      1. 削除済みページを検索対象に含める
      2. 最新リビジョンのみを検索対象とする

#### (4) 検索結果表示領域
  - 索結果を縦に列挙する
  - ソート順序はページID順 / スコア順 / パス順 で選択できるようにする。

### コンポーネントの配置
以下の図のように配置する。図中の番号とコンポーネントは以下の様に対応する。

  - (1) ヘッダ領域
  - (2) 検索式入力領域
  - (3) 検索設定領域
  - (4) 検索結果表示領域


```text
   +-------------------------+
   |           (1)           |
   +-------------------------+
   +-------------------------+
   |           (2)           |
   +-------------------------+
   +-------------------------+
   |           (3)           |
   +-------------------------+
   +-------------------------+
   |                         |
   |                         |
   |                         |
   |                         |
   |           (4)           |
   |                         |
   |                         |
   |                         |
   |                         |
   +-------------------------+

```

コンポーネント階層は以下の様に定義する。

  - ページビュー画面
      - ヘッダ領域
          - (1) ヘッダ領域
      - ボディ領域
          - (2) 検索式入力領域
          - (3) 検索設定領域
          - (4) 検索結果表示領域

#### 検索結果レコードの配置
以下の様に要素の配置を行う。図中の番号とコンポーネントは以下の様に対応する。

  - (1) ページID
  - (2) リビジョン番号
  - (3) 検索スコア
  - (4) パス
  - (5) 検索スニペット

(4)のパスの部分に閲覧ページへのリンクを設定する。また、削除済みのページの場合は、パス表示にサフィックスとして"(削除済み)"のマークを付ける。

```text
   +-----------+-------+---------+-----------------------------+
   |    (1)    |  (2)  |   (3)   |              (4)            |
   +-----------+-------+---------+-----------------------------+
   |                           (5)                             |
   +-----------------------------------------------------------+
```

## リビジョン管理画面

### レイアウト
T.B.D

### コンポーネント

#### (1) ページタイトル領域
  - ページタイトルとして、本文のトップレベルセクション名を表示する。トップレベルセクションが設定されていない場合はパスの末尾エレメントを表示する。
  - 表示スタイルはH1またH2とし、通常テキストより大きく表示する
  - 領域に入りきらない場合はellipsisではみ出た部分を切り捨てる

#### (2) ページパス領域
  - ページパスに対するパンくずリストを作成し表示する
  - パンくずの各階層にそれぞれのリンクを設定する
  - 表示スタイルはリンクスタイルを維持する
  - 領域に入りきらない場合はellipsisではみ出た部分を切り捨てる

#### (3) 操作ボタン領域
  - リンクスタイルのボタンを列挙配置する
  - 配置するボタンは以下の通り。いずれの場合もリビジョン一覧でリビジョン番号が一つだけ選択されている場合のみクリック可能となる。
      - ロールバック : 当該ページのカレントリビジョンを選択しているリビジョンまで巻き戻す　
      - コンパクション : 選択中のリビジョン以下のリビジョンを削除する(選択中のリビジョンを最古リビジョンにする)
  - ロールバックおよびコンパクションの実行前に確認モーダルを表示する

ボタンの配置は以下の様にする。

![操作ボタンレイアウト(表示)](./fig/revision-page_buttons.svg)

#### (4) リビジョン一覧
  - リビジョン番号を降順に並べ表示する
  - 各リビジョンは「リビジョン番号 / 更新ユーザ名 / 更新日時」を縦3行で表示する
    - 更新ユーザ名は領域から溢れる場合ellipsisで省略する
    - 更新日時はローカルタイムの `YYYY-MM-DD HH:mm:ss` 形式で表示し、タイムゾーンは表示しない
    - 更新ユーザ名/更新日時が未取得の場合は表示せず、領域のみ確保する
  - クリック操作によりリビジョン番号を選択できるようにする。またShiftキー + クリックでもう一つリビジョンを選択できるようにし、範囲選択できるようにする。
    - リビジョン番号が一つだけ選択されている場合、コンテンツパネルにはソース表示領域を表示し、選択されたリビジョンのMarkdownソースの表示を行う。
    - リビジョン番号が範囲選択された場合、コンテンツパネルには差分表示領域を表示し、選択されたリビジョン間での差分表示を行う

#### (5) ソース表示領域
  - リビジョン一覧でリビジョン番号が単一選択された場合のみ表示される
  - 選択されたリビジョンのMarkdownソースを表示する

#### (6) 差分表示領域
  - リビジョン一覧でリビジョン番号が範囲選択された場合のみ表示される
  - 選択されたリビジョン間のMarkdownソースの差分を表示する
  - 差分表示はjsdiffを使用し、新旧の位置関係はjsdiffの仕様に従う

#### (7) サイドパネル表示切り替えボタン
  - サイドパネルの表示・非表示を切り替えるボタンを、リンク形式のボタンで配置する

### コンポーネントの配置
以下の図のように配置する。図中の番号とコンポーネントは以下の様に対応する。

  - (1) ページタイトル領域
  - (2) ページパス領域
  - (3) 操作ボタン領域
  - (4) リビジョン一覧
  - (5) ソース表示領域
  - (6) 差分表示領域
  - (7) サイドパネル表示切り替えボタン

また、コンポーネント階層は以下の様に定義する。

  - ページビュー画面
      - ヘッダ領域
          - (1) ページタイトル領域
          - (2) ページパス領域
          - (3) 操作ボタン領域
      - ボディ領域
          - 表示切替ボタン
              - (7) サイドパネル表示切り替えボタン
          - サイドパネル
              - (4) リビジョン一覧
          - コンテンツパネル
              - (5) ソース表示領域
              - (6) 差分表示領域

#### 画面サイズmd以上

```text
   +-------------------------+
   |           (1)           |
   +-------------------------+
   |           (2)           |
   +-------------------------+
   |           (3)           |
   +-------------------------+
     (7)
   +-----+-------------------+
   |     |                   |
   |     |                   |
   |     |                   |
   |     |                   |
   | (4) |     (5) or (6)    |
   |     |                   |
   |     |                   |
   |     |                   |
   |     |                   |
   +-----+-------------------+
```

ボディ領域の高さは 100vh - 12.8emで固定させる。

#### 画面サイズmd未満

```text
   +-------------------------+
   |           (1)           |
   +-------------------------+
   |           (2)           |
   +-------------------------+
   |           (3)           |
   +-------------------------+
     (7)
   +-----+-------------------+
   |     |                   |
   |                         |
   |     |                   |
   |                         |
   | (4) |   (5) or (6)      |
   |                         |
   |     |                   |
   |                         |
   |     |                   |
   +-----+-------------------+
```

ボディ領域の高さは 100vh - 12.8emで固定させる。
なお、このサイズの場合は標準では(4)を表示しない。(7)のボタン操作によりサイドパネルを表示させる場合は(5) or (6)の領域にオーバーレイする形で表示させる(したがって(5) or (6)の領域の表示は変化なし)。
