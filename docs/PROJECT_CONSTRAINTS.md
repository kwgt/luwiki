# 本プロジェクト固有の制限事項

本ドキュメントでは、本プロジェクトに固有の制約事項を定義する。  
開発環境、ビルド環境、依存関係、外部ツールなどに関する前提条件を明確化し、再現性のある開発およびビルドを保証することを目的とする。

---

## 1. 本ドキュメントの対象

本ドキュメントは、以下の性格をもつ制約を対象とする。

- 本プロジェクト固有のもの  
- 他プロジェクトへは一般化しにくいもの  
- 環境依存・バージョン依存の内容  
- コーディング規約や AI アシスタントの一般ルールには含めない内容  

一般的なコーディング規約や AI アシスタント運用ルールは、以下の文書を参照すること。

- AI_ASSISTANT_RULES.md
- CODING_RUST.md
- CODING_TYPESCRIPT.md
- CODING_VUE3.md

---

## 2. 総則（プロジェクト全体に共通する制約）

- 本書に記載された制約に違反して得られた成果物・検証結果は無効とみなす  
- 仕様上の判断に迷う場合は REQUIREMENTS.md を優先して確認する  
- 不明点は推測せず、質問または確認プロセスを踏むこと  

---

## 3. Rust ビルド環境に関する制約

### 3.1 チェックおよび検証に関する制約

- コード変更後は `cargo check` によりコンパイル検証を行うこと  
- `cargo check`の実行は許可を取る必要は無い
- 依存関係を追加・更新した場合も同様とする  
- ネイティブ依存クレート起因の失敗は、まず環境制約違反を疑うこと

### 3.2 Windows環境に於けるツールチェイン

本プロジェクトでは以下の条件を満たす環境で Rust のビルドを行う。

- Rust は **MSVC ツールチェイン**を使用する  
- ビルドおよび `cargo` 操作は Visual Studio 2022 Developer Command Prompt 上で実行する  
- Visual Studio 2026 付属の cl.exe を使用してはならない

上記条件を満たさない環境で得られたビルド結果は無効とみなす。

VIsual Studio 2022環境はrustupで依存インストールされた物を使用すること。通常は "C:\Program Files (x86)\Microsoft Visual Studio\2022"にインストールされているので、これを元に必要なVsDevCmd.batを探し実行することを許可する。

#### 3.2.1 コンパイラ確認方法

```
cl
```

以下を満たすことを事前確認とする。

- 表示されるバージョンが Visual Studio 2022 に対応していること  
- 実行パスが Visual Studio 2022 のディレクトリ配下であること  

### 3.2.2 依存クレートに関する制約

本プロジェクトは、ネイティブコードを含む依存クレートを利用する。

- `zstd-sys`

これらの依存関係により、以下の制約が発生する。

- Microsoft VisualAtudio 2022のC/C++ コンパイラが必要である  
- ツールチェインの種類およびバージョンに依存する  
- 不適切な cl.exe が選択された場合、ビルドが失敗する  

### 3.2.3 PATH および環境変数に関する制約

- Visual Studio 2026 のツールチェインを優先させるような PATH 構成を行ってはならない
- 理由の説明なく PATH を書き換えてはならない
- どのコンパイラが使用されているか不明な状態でのビルドを実行してはならない

### 3.2.4 VS2022環境の起動手順（AI/自動化用）

"C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\Common7\Tools\VsDevCmd.bat"を用いて、開発者プロンプト上でcargoを実行すること。

例: `cmd /c "<VsDevCmd.batのフルパス> -arch=x64 -host_arch=x64 && cd /d <workspace> && cargo check"`

AI/自動化を含む全ての実行者は、cargo系コマンドを必ず VsDevCmd.bat 経由で実行し、
その前に cl のバージョン確認を行う。これに反する実行結果は無効とする。

---

## 4. TypeScript / フロントエンドビルド環境に関する制約（予定枠）

※ 現時点では具体制約を未定義とする。今後フロントエンド開発の進展に応じて以下を記載する。

- Node.js / npm / パッケージマネージャのバージョン制約  
- ビルドツール（例：Vite / Webpack 等）のバージョン  
- 依存モジュールに関する制約  
- Lint / Format ルールに関する強制事項  

---

## 5. フロントエンド成果物の取り扱いに関する制約

本プロジェクトの Web フロントエンドは npm によってビルドされ、生成された静的リソース（HTML / CSS / JavaScript / 画像等）は、Rust サーバに組み込みリソースとして内包される。

以下の制約を設ける。

- フロントエンドのビルド成果物は **rust-embed クレートを用いて実行ファイルに埋め込む**  
- 実行時に外部ファイルとして参照する構成は採用しない  
- サーバ起動時に静的ファイルをファイルシステムから読み込む設計を禁止する  

必要に応じて、上記の制約を満たすための `build.rs` を作成してよい。

---

## 6. 例外

本ドキュメントに規定された制約の例外は以下のみとする。

- 明示的にユーザーが許可した場合  
- 本ドキュメントが改訂され、例外が明文化された場合  

---
