# マクロ仕様書
本書ではアプリケーションに組み込むマクロについて定義する。

## 基本仕様
- 以下の3つのタイプをサポートする。
  - 入力時に即座に展開される即時変換型
  - レンダリング時に展開されるレンダリング時変換型
  - 特例マクロ

## マクロ一覧

  | マクロ名 | 種別 | 機能
  |:--|:--|:--
  | `now[:utc][:iso8601]` | 即時変換型 | [現在の日時を展開](#macro-now)
  | `today[:utc][:iso8601]` | 即時変換型 | [現在の日付を展開](#macro-today)
  | `page[:id]` | 即時変換型 | [ページ情報を展開](#macro-page)
  | `user[:display]` | 即時変換型 | [ユーザ情報を展開](#macro-user)
  | `children[:depth={number}][:recursive]` | レンダリング時変換型 | [子ページのリストへ展開](#macro-children)
  | `toc[:depth={number}]` | レンダリング時変換型 | [ページ内のTOCへ展開](#macro-toc)
  | `include_code:src={asset_path}[:lang={string}]` | レンダリング時変換型 | [アセットのコードブロック展開](#macro-include_code)
  | `include_csv:src={asset_path}` | レンダリング時変換型 | [アセットのテーブル展開](#macro-include_csv)
  | `[[{page_path}]]` | 特例型 | [ページへのリンク](#macro-page_link)
  | `[[{page_path}\|{alias_name}]]` | 特例型 | [ページへのリンク](#macro-alias_link)
  | `![[asset:{asset_path}]]` | 特例型 | [アセットの埋め込み](#macro-asset_link)

## 即時変換型マクロ
即時変換型は編集画面のエディタ上で入力時にリアルタイムに展開が行われる(このためソースには残らない)。

入力形式は`{{マクロ名:引数..}}`とする。

例を上げると以下のような記述となる。
- `{{now}}`
- `{{now:utc:iso8601}}`

<a id="macro-now"></a>
### now
現在の日時を展開する。

#### 引数

| 引数 | 意味 | 省略形 | 指定
|:--|:--|:--|:--
| `utc`     | UTCでの日時展開を行う   | (なし) | 任意
| `iso8601` | ISO8601形式で展開を行う | `iso`  | 任意

#### 注記
- `utc`が指定されなかった場合はローカルタイムで展開が行われる。
- `iso8601`が指定されなかった場合は年月日区切りが"/"で展開が行われる。

<a id="macro-today"></a>
### today
現在の日付を展開する。

#### 引数

| 引数 | 意味 | 省略形 | 指定
|:--|:--|:--|:--
| `utc`     | UTCでの日付展開を行う   | (なし) | 任意
| `iso8601` | ISO8601形式で展開を行う | `iso` | 任意

#### 注記
- `utc`が指定されなかった場合はローカルタイムで展開が行われる。
- `iso8601`が指定されなかった場合は年月日区切りが"/"で展開が行われる。

<a id="macro-page"></a>
### page
現在のページの情報を展開する。

#### 引数
デフォルトではページパスを展開する

| 引数 | 意味 | 省略形 | 指定
|:--|:--|:--|:--
| `id` | ページIDの展開を行う | (なし) | 任意

<a id="macro-user"></a>
### user
ユーザ情報を展開する。

#### 引数
デフォルトではユーザIDへの展開を行う。

| 引数 | 意味 | 省略形 | 指定
|:--|:--|:--|:--
| `display` | 表示名の展開を行う | `d` | 任意

## レンダリング時変換型マクロ

入力形式は`{{マクロ名:引数..}}`とする。例を上げると以下のような記述となる。

例を上げると以下のような記述となる。

- `{{children:depth=3}}`
- `{{include_code:src=test.cpp:lang=cpp}}`

<a id="macro-children"></a>
### children
配下のページへのリンクをアイテムとしたリストに展開される。

#### 引数

| 引数 | 意味 | 省略形 | 指定
|:--|:--|:--|:--
| `depth={number}` | 表示名の展開を行う見出しの深さ | `d` | 任意
| `recursive` | 再帰的に配下のページ全てを展開 | `r` | 任意

#### 注記
- `depth`と`recursive`の両方が指定されなかった場合は`depth=1`として扱う(直下のページのみでリストを構成)。
- `depth`と`recursive`の同時指定はエラーとして扱う

<a id="macro-toc"></a>
### toc
ページ内へのTOCをリストとして展開する。

#### 引数

| 引数 | 意味 | 省略形 | 指定
|:--|:--|:--|:--
| `depth={numer}` | 表示名の展開を行う | `d` | 任意

#### 注記
- `depth`が指定されなかった場合は`depth=3`として扱う(第2〜4レベル見出しの3レベル分でリストを構成する)。

<a id="macro-include_code"></a>
### include_code
アセットを読み込みコードブロックに展開する。

#### 引数

| 引数 | 意味 | 省略形 | 指定
|:--|:--|:--|:--
| `src={string}`  | コードブロックに展開するアセットへのパス | `s` | 必須
| `lang={string}` | コードブロックに対する言語指定 | `l` | 任意

##### 注記
- `lang`を指定しなかった場合はMIME種別から推測される言語指定を行う
- MIME種別が`text/*`に一致しないアセットが指定された場合ははエラーとなる。

<a id="macro-include_csv"></a>
### include_csv
アセット(CSV)を読み込みテーブルに展開する。

| 引数 | 意味 | 省略形 | 指定
|:--|:--|:--|:--
| `src={string}`  | テーブルに展開するアセットへのパス | `s` | 必須

##### 注記
- MIME種別が`text/csv`に一致しないアセットが指定された場合ははエラーとなる。

## 特例型マクロ

特例型マクロは、他システムの入力形式のエミュレートなどを行うためのマクロとして定義される。

<a id="macro-page_link"></a>
### `[[{page_path}]]` : ページリンクマクロ
Scrapbox / WikiWiki / Obsidian 系由来

#### 引数

| 引数 | 意味 | 指定
|:--|:--|:--
| `{page_path}`  | リンク先のページパス | 必須

### 注記
- `[[/path/to/page#fragment]]`は`[page](/path/to/page#fragment)`と等価に展開される。

<a id="macro-alias_link"></a>
### `[[{page_path}|{alias_name}]]` : ページリンクマクロ
Scrapbox / WikiWiki 系由来

#### 引数

| 引数 | 意味 | 指定
|:--|:--|:--
| `{page_path}`  | リンク先のページパス | 必須
| `{alias_name}`  | 別名 | 必須

### 注記
- `[[/path/to/page#fragment|alias]]`は`[alias](/path/to/page#fragment)`と等価に展開される。

<a id="macro-asset_link"></a>
### `![[asset:{asset_path}]]` : アセットの埋め込み
Obsidian 系由来

#### 引数

| 引数 | 意味 | 指定
|:--|:--|:--
| `{asset_path}`  | アセットへのパス | 必須

### 注記
- `![[asset:/path/to/page:image.png]]`は`[image.png](!asset:/path/to/page:image.png)`と等価に展開される。


