# 要求仕様

本ドキュメントは、ローカル環境で使用する Wiki システムに関する要求仕様を定義する。
実装支援として Codex CLI 等のツールに入力することを想定し、挙動・制約・優先度を明確化する。

---

## 1. システム概要

- ローカルで利用する個人向け Wiki
- バックエンドは Rust + redb を想定
- ページは Markdown で記述され、HTML にレンダリングして表示される
- ページには履歴（リビジョン）が存在する

---

## 2. ページの基本要件

### 2.1 ページ識別

- 各ページは以下を持つ
  - **page_id**（ULID 等の一意な不変 ID）
  - **path**（人間向けのパス表現）
- page_id はページ作成時に一度だけ発行され、以後変更されない
- path は rename により変更可能

### 2.2 ページパスの仕様
- パスセパレータは'/'
- 絶対パスの場合は'/'から始まること
- UTF-8でエンコード可能な可読文字であれば制限を設けない


### 2.3 ルートページ

- ルートページのパスは "/" とする
- 初回起動時（最初のユーザ登録後）に雛形データから自動作成する
  - 雛形データは実行ファイルに埋め込みリソースとして保持する
- ルートページは削除不可とする（ソフト／ハードのいずれも禁止）
- ルートページのリネームは禁止とする

---

## 3. ページ履歴（リビジョン）

### 3.1 リビジョン管理

- 各ページは単調増加のリビジョン番号（u64）を持つ
- リビジョンは歯抜けを許可しない
- 最新リビジョンと最古リビジョン（gc_min）はページ単位で管理される

### 3.2 リビジョン操作

- ページ編集は常に新しいリビジョンを作成する
- 例外として、誤字/誤記の修正に限り最新リビジョンを維持する保存（amend）を許可する
- ページ rename も **1 リビジョンとして扱う**
  - 内容が変わらなくてもリビジョンは増加する

### 3.3 新規ページ作成（ドラフト）

- 新規作成はドラフトとして登録する
- ドラフトはソースを持たず、ページIDとパスのみを持つ
- ドラフト作成は `POST /api/pages?path={page_path}` で行い、同時にロックを取得する
- ドラフトに対する `GET /api/pages/{page_id}/source` は 404 を返す
- ドラフトに対する `PUT /api/pages/{page_id}/source` が成功した時点で通常ページとして登録され、リビジョン番号は1となる
- ドラフトはロック解除やロック期限切れにより削除される

---

## 4. ページ削除

### 4.1 ソフトリムーブ

- ページ削除操作のデフォルトはソフトリムーブ
- ソフトリムーブされたページは以下の扱いとする
  - 一覧には表示されない(検索対象にはなる)
  - データ・履歴は保持される
  - path は予約せず再利用可能
  - 削除済みページは page_id → path の解決を行わない
  - 削除済みページのソースは page_id 指定で取得可能とする

### 4.2 ハードリムーブ

- 明示的な管理操作としてハードリムーブを提供する
- ハードリムーブでは以下を行う
  - 対象ページの全リビジョンを物理削除
  - ページインデックスを削除
- ハードリムーブ後は同一 path の再利用を許可する

#### ドラフト削除

- ドラフトの削除はハードリムーブ扱いとする
- ドラフト削除後は同一 path の再利用を許可する
- ドラフトに紐付くアセットは同時に削除する

---

## 5. ページ rename

### 5.1 基本動作

- rename は page_id を維持したまま path のみを変更する
- rename 操作時に新しいリビジョンを追加する

### 5.2 rename 履歴

- rename を行ったリビジョンには以下の付加情報を持たせる
  - 旧パス（from）
  - 新パス（to）
- rename 履歴は 1 段分のみ保持すればよい

---

## 6. 内部リンク

### 6.1 基本方針

- 内部リンクは以下の二層構造を持つ
  - 入力・表示：path
  - 内部表現：page_id

### 6.2 編集時

- ユーザは相対パス・絶対パスでリンクを記述できる
- 保存時に以下を行う
  - 相対パスを正規化
  - path から page_id を解決
  - 解決できたリンクは page_id 形式に変換して保存

### 6.3 未存在リンク

- リンク先が未存在の場合
  - 未存在リンクとして表示する
  - クリック時に新規ページ作成フローへ遷移する

---

## 7. rename 時のリンクの扱い

### 7.1 他ページからのリンク

- rename 対象ページへの他ページからのリンクは放置する
- page_id により自動的に新しい path へ解決される

### 7.2 rename 対象ページ内のリンク

- 絶対パスリンク：放置
- 相対パスリンク：
  - 可能な限り同一 page_id を指すように変換
  - 変換後に存在状態が変わる場合は警告を通知

---

## 8. リビジョン表示 UI

### 8.1 リビジョン切り替え

- リビジョン番号のドロップダウンで切り替えを行う
- rename リビジョンはドロップダウン内で強調表示する

### 8.2 差分表示（diff）

- 全リビジョンで diff 表示をサポートする
- rename リビジョンも通常の diff 表示を行う
- diff とは別枠で以下を表示する
  - 旧パス → 新パス
  - page_id（同一であることの確認）

---

## 9. 履歴表示

- 履歴表示ボタンを提供する
- 履歴は Markdown で生成する
- 表示時は HTML にレンダリングする
- ダウンロード／クリップボードコピー時は Markdown をそのまま提供する

---

## 10. 補助機能

- 現在ページの page_id を容易に取得できる
- page_id から現在の path を解決できる機能を提供する
  - 削除済みページは対象外とする
- page_id を直接指定したリンク記法を許可する（高度ユーザ向け）

---
## 11. ユーザ認証・ユーザ識別

### 11.1 基本方針

- 本システムはローカル利用を前提とするが、
- 操作主体を識別するためにユーザ認証をサポートする
- 認証の主目的は アクセス制御ではなく履歴の帰属 とする

### 11.2 ユーザ識別

- 各ユーザは一意な user_id を持つ
- user_id は以下のいずれかの方式で実現できること
  - ローカル設定ファイルによる固定 ID
  - OS のログインユーザ名を元にした識別子
  - 将来的な拡張として外部認証方式

### 11.3 履歴との関連

- ページの各リビジョンには、その操作を行った user_id を関連付けられること
- 履歴表示時に以下を確認できること
  - 操作日時
  - 操作ユーザ

### 11.4 ユーザ認証の方法

- Basic認証を用いてブラウザ上で認証を行う

### 11.5 ユーザ情報の管理

- ユーザ情報はデータベース上で管理する

---
## 12. 全文検索

### 12.1 基本要件

- ページ内容を対象とした全文検索機能を提供する
- 全文検索は以下を満たすこと
  - ページ数増加時にも実用的な性能を維持できる
  - リネームや履歴構造と整合が取れる
- 全文検索は独立した検索画面で行い、検索式のリアルタイム評価を行う。

### 12.2 検索対象

- 検索対象は以下の通り
  - 記事中の見出し
  - 記事の本文
  - コードブロック
- 過去リビジョン及びソフトデリート状態の記事を含めて検索対象とする

### 12.3 検索結果

- 検索結果には以下の情報を含める
  - ページ識別子（page_id）
  - ページの現在の path。ただし削除記事の場合は、過去に割り当てられていたパスで代用(その旨が判る表記にする)。
  - マッチしたテキストのスニペット
- 検索結果は入力された検索結果及び、検索対象について最大100件を表示する

### 12.4 履歴・リネームとの関係
- リネームは全文検索の索引単位に影響しない
  - 検索結果は常に 現在の path で表示される
  - 将来的な拡張として、以下を検討可能とする
    - 過去リビジョンを含めた全文検索

---

## 13. アセット管理

- ページに添付されるファイル（画像・資料・その他バイナリ）は アセット と呼ぶ
- アセットはページと紐付いてアップロードされるが、他ページから参照可能である
- アセットには一意な識別子（asset_id、ULID）を付与し、永続的に不変とする
- アセット本体はデータベースに保存せず、ファイルシステムに保存する
  - 保存場所は $XDG_DATA_HOME/<app>/asset/ を基準とする
  - アセットIDに基づき、ディレクトリを2階層（先頭2桁 + 続く3桁）で分散配置する
- ページとアセットの紐付けには多対多関係を許容し、以下を実現する
  - ページ削除時の参照切り離し
  - 他ページからの参照維持
- 内部的には (PageId → AssetId) の対応を管理し、逆引き (AssetId → PageId) は必要に応じて利用する

---

### 13.1 アセット参照記法

- Markdown 内でのアセット参照は asset: プレフィクスを用いる
- 書式例:
```Markdown
![](asset:./foo:banner.png)
```
- asset: 記法には以下を許可する
  - 相対パスによる参照
  - 絶対パスによる参照
  - 所属ページ以外からの参照
- Markdown ソース保存時には asset_id に変換しない<br>→ 保守性・編集性を優先する

---
## テンプレート機能

- ページ編集時に、ページのテンプレートを初期ソースとして用いる機能を実装する。
- テンプレートはシステム設定指定されたWiki上のパスの子ページ(直下の1階層のみ)を用いる
- システム設定でテンプレート格納パスが指定されない場合はテンプレート機能自体を無効化する
